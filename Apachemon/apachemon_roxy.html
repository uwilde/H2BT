<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Apachichu vs. Roxy — Pokémon GBA Layout</title>
<style>
  :root{
    /* FireRed/LeafGreen-ish palette */
    --bg:#d0e7f2;             /* sky */
    --panel:#f8f9f7;          /* UI panels */
    --ink:#0b0b0b;            /* borders */
    --hp:#4fb759; --hp2:#2a812f; /* HP fill */
    --mp:#57a9ff; --mp2:#2a6fb3; /* MP fill (custom) */
    --accent:#2f6af6;         /* selection outline */
  }
  *{box-sizing:border-box; image-rendering: pixelated}
  html,body{height:100%;width:100%;margin:0;background:#0f0f10;color:var(--ink);font-family:'Press Start 2P',ui-monospace,Menlo,Consolas,monospace;font-size:14px}
  @font-face{font-family:'Press Start 2P';src:local('Press Start 2P'), local('PressStart2P');font-display:swap}

  /* Screen container sized near GBA aspect (240x160 => 3:2) */
  .root{width:100%;height:100%;margin:0;padding:0;display:flex;align-items:center;justify-content:center}
  .screen{width:100%;height:100%;background:var(--bg);border:8px solid #6e7b79;border-radius:14px;position:relative;overflow:hidden;box-shadow:0 0 0 6px #2f3a39,0 12px 40px rgba(0,0,0,.55)}

  /* Battle field */
  .field{position:absolute;left:12px;right:12px;top:12px;height:80%;background:linear-gradient(#a9d9f6 65%, #78a7c1 0);border:4px solid #0c2a36;border-radius:6px;z-index:1}
  .pad{position:absolute;inset:0;padding:14px}

  .enemy,.player{position:absolute;width:260px;height:240px;display:flex;align-items:flex-end;justify-content:center}
  .enemy{right:28px;top:14px}
  .player{left:38px;bottom:18px}
  .enemy img,.player img{max-width:240px;max-height:240px}
  .enemy img { position:fixed;top:19px;right:117px; }
  .player img { position:fixed; left:38px; top:110px; }

  /* Enemy info (top-left) */
  .enemyInfo{position:absolute;left:22px;top:18px;width:280px;background:var(--panel);border:4px solid var(--ink);padding:8px;border-radius:6px;z-index:2}
  .row{display:flex;align-items:center;justify-content:space-between;margin-bottom:15px;}
  .lvl::before{content:'Lv'}
  .hpWrap{margin-top:8px;border:3px solid var(--ink);height:12px;position:relative;background:#dbdbdb}
  .hpBar{height:100%;background:linear-gradient(var(--hp),var(--hp2));width:100%}
  .nums{position:absolute;right:6px;top:-18px;font-size:12px}

  /* Player info (bottom-right above HUD) */
  .playerInfo{position:absolute;right:12px;bottom:140px;width:172px;background:var(--panel);border:4px solid var(--ink);padding:8px;border-radius:6px;z-index:3}
  .mpWrap{margin-top:16px;border:3px solid var(--ink);height:12px;position:relative;background:#dbdbdb}
  .mpBar{height:100%;background:linear-gradient(var(--mp),var(--mp2));width:100%}

  /* HUD: bottom area split text + 2x2 menu to mimic GBA */
  .hud{position:absolute;left:12px;right:12px;bottom:12px;height:120px;display:grid;grid-template-columns:1fr 1fr;gap:12px;z-index:3}
  .textbox{border:4px solid var(--ink);background:var(--panel);padding:14px;border-radius:6px;display:flex;align-items:flex-start;justify-content:flex-start}

  .menu{border:4px solid var(--ink);background:var(--panel);padding:10px;border-radius:6px;display:grid;grid-template-columns:1fr 1fr;grid-auto-rows:1fr;gap:10px}
  .menu button{font:inherit;padding:12px 14px;text-align:left;border:3px solid var(--ink);background:#eef2f1;cursor:pointer;border-radius:4px}
  .menu button.sel{outline:4px solid var(--accent)}

  /* Fight modal overlay */
  .overlay{position:absolute;inset:0;background:rgba(0,0,0,.45);display:none;align-items:flex-end;justify-content:center;z-index:5}
  .overlay.show{display:flex}
  .fightModal{width:88%;max-width:680px;margin-bottom:40px;display:grid;grid-template-columns:1fr 220px;gap:12px}
  .moves{border:4px solid var(--ink);background:var(--panel);border-radius:6px;padding:10px;display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .moves button{font:inherit;padding:12px 10px;text-align:left;border:3px solid var(--ink);background:#eef2f1;cursor:pointer;border-radius:4px}
  .moves button.sel{outline:4px solid var(--accent)}
  .moveInfo{border:4px solid var(--ink);background:var(--panel);border-radius:6px;padding:10px;display:grid;grid-template-rows:auto 1fr auto;gap:8px}
  .moveTitle{font-weight:bold}
  .moveMeta{font-size:12px}
  .modalActions{display:flex;justify-content:flex-end}
  .modalActions button{font:inherit;border:3px solid var(--ink);padding:10px 12px;background:#eef2f1;cursor:pointer;border-radius:4px}

  .hidden{display:none !important}
  .hit{filter:contrast(150%) saturate(150%)}
  .rear{animation:rear .34s ease}
  .step{animation:step .34s ease}
  .flex{animation:flex .36s ease}
  @keyframes rear{0%{transform:translateY(0)}50%{transform:translateY(-14px)}100%{transform:translateY(0)}}
  @keyframes step{0%{transform:translateX(0)}50%{transform:translateX(10px)}100%{transform:translateX(0)}}
  @keyframes flex{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}

  @media (max-width: 720px){
    .field{height:calc(100% - 12px - 250px)}
    .hud{grid-template-columns:1fr;height:250px}
    .playerInfo{right:18px;bottom:260px;width:300px}
    .enemyInfo{left:16px;top:14px;width:260px}
    .fightModal{grid-template-columns:1fr;}
  }

  *{ user-select:none; -webkit-user-select:none; -ms-user-select:none; }
  body{ -webkit-tap-highlight-color:transparent }

  /* Attention pulse for the textbox during intro */
  .textbox.attn{
    position:relative;
    animation:pulseBox 1.2s ease-in-out infinite;
    box-shadow:0 0 0 0 rgba(47,106,246,.45);
    outline:4px solid rgba(47,106,246,.35);
  }
  .textbox.attn::after{
    content:"tap/click to continue ▸";
    position:absolute; right:12px; bottom:10px;
    font-size:12px; opacity:.9;
    animation:blinkHint 1s steps(2,end) infinite;
  }
  @keyframes pulseBox{
    0%,100%{ box-shadow:0 0 0 0 rgba(47,106,246,.45) }
    50%{ box-shadow:0 0 16px 4px rgba(47,106,246,.35) }
  }
  @keyframes blinkHint{ 0%{opacity:0} 50%{opacity:1} }

  /* --- BATTLE TRANSITION (bars + quick fade) --- */
  .encounter{
    position:absolute; inset:0; z-index:9999;
    display:none; pointer-events:none; background:transparent;
    opacity:0;
  }
  .encounter.show{
    display:grid;
    grid-template-rows:repeat(12,1fr);
    background:#000;
    opacity:1;
    transition:opacity 140ms ease;
  }
  .encounter .bar{ background:#fff; transform:translateX(100%); }
  .encounter .bar.r{ transform:translateX(-100%) }
  @keyframes barIn{
    0%{ transform:translateX(var(--from,100%)) }
    100%{ transform:translateX(0%) }
  }
  @keyframes barOut{
    0%{ transform:translateX(0%) }
    100%{ transform:translateX(var(--to,-100%)) }
  }
  .encounter.show .bar{
    animation:
      barIn 220ms ease forwards,
      barOut 260ms ease 240ms forwards;
  }

  .screen.displace > :not(#encounter){
    animation:displace 420ms ease;
    will-change:transform, filter;
  }
  @keyframes displace{
    0%   { transform:translate3d(0,0,0) skewX(0deg) scale(1); filter:none; }
    15%  { transform:translate3d(2px,0,0) skewX(-2deg) scale(1.005); }
    30%  { transform:translate3d(-2px,1px,0) skewX(2deg)  scale(1.008); }
    45%  { transform:translate3d(1px,-1px,0) skewX(-1deg) }
    60%  { transform:translate3d(-1px,0,0) skewX(1deg) }
    100% { transform:translate3d(0,0,0,0.5) skewX(0deg) scale(1); filter:none; }
  }
  .screen.displace::before{
    content:"";
    position:absolute; inset:0; z-index:4; pointer-events:none;
    background:repeating-linear-gradient(
      to bottom,
      rgba(0,0,0,.06) 0px, rgba(0,0,0,.06) 2px,
      transparent 2px, transparent 4px
    );
    animation:scan 420ms linear;
  }
  @keyframes scan{
    0%{ background-position:0 0 }
    100%{ background-position:0 12px }
  }

  /* =========================
     PERSISTENT SCREEN FX
     ========================= */
  .screen{ position:relative }
  .screen::before,
  .screen::after{
    content:"";
    position:absolute; inset:0; pointer-events:none; z-index:4;
    opacity:0;
  }
  .screen.fx-crt{
    filter: contrast(1.08) saturate(1.06) brightness(0.98);
    transform: perspective(1600px) translateZ(0);
  }
  .screen.fx-crt::before{
    opacity:0.25;
    background:
      linear-gradient(to right,
        rgba(255,0,0,0.03) 0, rgba(255,0,0,0.03) 33.33%,
        rgba(0,255,0,0.03) 33.34%, rgba(0,255,0,0.03) 66.66%,
        rgba(0,128,255,0.03) 66.67%, rgba(0,128,255,0.03) 100%
      ),
      repeating-linear-gradient(
        to bottom,
        rgba(0,0,0,.02) 0px, rgba(0,0,0,.09) 2px,
        rgba(0,0,0,0) 2px,  rgba(0,0,0,0) 4px
      );
    mix-blend-mode: multiply;
    animation: crt-flicker 1.8s steps(2,end) infinite;
  }
  .screen.fx-crt::after{
    opacity:0.5;
    background:
      radial-gradient(120% 85% at 50% 50%,
        rgba(0,0,0,0) 60%,
        rgba(0,0,0,.12) 100%
      );
    box-shadow: inset 0 0 60px rgba(0,0,0,.25);
  }
  .screen.fx-crt.fx-pop{ animation: crt-pop 320ms ease; }
  @keyframes crt-flicker{ 0%{ opacity:.98 } 50%{ opacity:1 } 100%{ opacity:.98 } }
  @keyframes crt-pop{
    0%   { transform:perspective(1600px) rotateX(.2deg) rotateY(-.25deg) }
    50%  { transform:perspective(1600px) rotateX(-.2deg) rotateY(.2deg) }
    100% { transform:perspective(1600px) rotateX(0) rotateY(0) }
  }
  @media (prefers-reduced-motion: reduce){
    .screen.fx-crt::before{ animation:none }
    .screen.fx-crt.fx-pop{ animation:none }
  }

  /* --- GAME BOY MODE --- */
  .screen.fx-gb{ filter: contrast(1.05) saturate(0.85) hue-rotate(-8deg) brightness(1.02); }
  .screen.fx-gb::before{
    opacity:0.6;
    background:
      linear-gradient(rgba(187,210,142,.35), rgba(187,210,142,.35)),
      radial-gradient(circle at 1px 1px, rgba(0,0,0,.12) 0 0.6px, transparent 0.6px),
      radial-gradient(circle at 0.5px 0.5px, rgba(0,0,0,.06) 0 0.5px, transparent 0.5px);
    background-size:100% 100%,3px 3px,3px 3px;
    mix-blend-mode: multiply;
  }
  .screen.fx-gb::after{
    opacity:1;
    background:radial-gradient(120% 85% at 50% 50%, rgba(0,0,0,0) 62%, rgba(0,0,0,.10) 100%);
  }

  /* === Result Popup === */
  .resultOverlay{
    position:absolute; inset:0; z-index:99999;
    display:none; align-items:center; justify-content:center;
    background:rgba(0,0,0,.55);
  }
  .resultOverlay.show{ display:flex; }
  .resultBox{
    width:min(680px,90%); background:var(--panel); color:var(--ink);
    border:6px solid var(--ink); border-radius:10px; padding:18px;
    box-shadow:0 18px 50px rgba(0,0,0,.6);
  }
  .resultTitle{ font-weight:700; margin-bottom:10px; }
  .resultMsg{ line-height:1.5; margin-bottom:16px; }
  .resultActions{ display:flex; justify-content:flex-end; }
  .resultActions button{
    font:inherit; border:3px solid var(--ink); padding:10px 14px;
    background:#eef2f1; cursor:pointer; border-radius:6px;
  }

  /* === Hearts particles for Seductive Neigh === */
  .heart{
    position:fixed;
    width:12px; height:12px;
    background: #ff6aa3;
    transform: rotate(45deg);
    opacity: 0.9;
    z-index: 9999;
    pointer-events:none;
    animation: heartRise 900ms ease-out forwards;
  }
  .heart::before, .heart::after{
    content:"";
    position:absolute;
    width:12px; height:12px;
    background:#ff6aa3;
    border-radius:50%;
  }
  .heart::before{ left:-6px; top:0; }
  .heart::after { left:0; top:-6px; }

  @keyframes heartRise{
    0%{ transform:translate(0,0) rotate(45deg) scale(0.8); opacity:0 }
    10%{ opacity:1 }
    100%{ transform:translate(-6px,-46px) rotate(45deg) scale(1.15); opacity:0 }
  }
</style>
</head>
<body>
<div class="root">
  <div class="screen" id="game">
    <div id="encounter" class="encounter" aria-hidden="true"></div>
    <div class="field">
      <div class="pad">
        <div class="enemy"><img id="enemySprite" src="roxy.png" alt="Roxy"></div>
        <div class="player"><img id="playerSprite" src="apchichu.png" alt="Apachichu"></div>
        <div class="enemyInfo">
          <div class="row"><strong>ROXY</strong><span class="lvl">32</span></div>
          <div class="hpWrap"><div class="hpBar" id="eHP"></div><span class="nums" id="eHPtxt">HP 80/80</span></div>
        </div>
      </div>
    </div>

    <!-- Player vitals -->
    <div class="playerInfo" id="playerInfo">
      <div class="row"><strong>APACHICHU</strong><span class="lvl">51</span></div>
      <div class="hpWrap"><div class="hpBar" id="pHP"></div><span class="nums" id="pHPtxt">HP 120/120</span></div>
      <div class="mpWrap"><div class="mpBar" id="pMP"></div><span class="nums" id="pMPtxt">MP 40/40</span></div>
    </div>

    <!-- HUD: text + 2x2 menu -->
    <div class="hud">
      <div class="textbox" id="textbox">Apachichu entered the arena. Roxy flicked her mane and blew a kiss. Tap/click to continue…</div>
      <div class="menu" id="mainMenu">
        <button data-action="FIGHT" class="sel">FIGHT</button>
        <button data-action="ITEMS">BAG</button>
        <button data-action="INFO">INFO</button>
        <button data-action="RUN">RUN</button>
      </div>
    </div>

    <!-- Fight overlay -->
    <div class="overlay" id="fightOverlay" aria-hidden>
      <div class="fightModal" role="dialog" aria-modal="true">
        <div class="moves" id="fightMenu"></div>
        <div class="moveInfo">
          <div class="moveTitle" id="moveTitle">Select a move</div>
          <div class="moveDesc" id="moveDesc">Press Enter/Space to use. Esc to cancel.</div>
          <div class="moveMeta" id="moveMeta">MP — | Damage —</div>
          <div class="modalActions"><button id="cancelFight">CANCEL</button></div>
        </div>
      </div>
    </div>

    <!-- Items (BAG) menu overlay (compact) -->
    <div class="overlay" id="bagOverlay" aria-hidden>
      <div class="fightModal" role="dialog" aria-modal="true">
        <div class="moves" id="itemMenu"></div>
        <div class="moveInfo">
          <div class="moveTitle">Bag</div>
          <div class="moveDesc">Choose an item to use on Apachichu.</div>
          <div class="modalActions"><button id="closeBag">CLOSE</button></div>
        </div>
      </div>
    </div>

    <!-- WIN/LOSE popup -->
    <div class="resultOverlay" id="resultOverlay" aria-hidden="true">
      <div class="resultBox" role="dialog" aria-modal="true">
        <div class="resultTitle" id="resultTitle">Result</div>
        <div class="resultMsg" id="resultMsg"></div>
        <div class="resultActions">
          <button id="resultYes">YES</button>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
const SPEED = {
  enemyRead: 1100,  // time to read "Roxy used X!"
  windup:    650,   // animation wind-up before the hit lands
  postHit:   900    // linger on damage/miss text before player's turn
};

/*********** AUDIO ***********/
class Chiptune{
  constructor(){this.ctx=new (window.AudioContext||window.webkitAudioContext)();this.master=this.ctx.createGain();this.master.gain.value=0.12;this.master.connect(this.ctx.destination);}
  beep(f=440,d=0.12,t='square',v=0.6){const o=this.ctx.createOscillator(),g=this.ctx.createGain();o.type=t;o.frequency.setValueAtTime(f,this.ctx.currentTime);g.gain.value=v;o.connect(g);g.connect(this.master);o.start();o.stop(this.ctx.currentTime+d);}
  blip(){[660,880,990].forEach((f,i)=>setTimeout(()=>this.beep(f,0.05,'square',0.5),i*45));}
  hit(){[120,150,200,90].forEach((f,i)=>setTimeout(()=>this.beep(f,0.05,'square',0.4),i*40));}
  miss(){[220,160,120].forEach((f,i)=>setTimeout(()=>this.beep(f,0.07,'triangle',0.3),i*60));}
  heal(){[523,659,784].forEach((f,i)=>setTimeout(()=>this.beep(f,0.09,'square',0.5),i*80));}
  lose(){[300,240,180,120,90].forEach((f,i)=>setTimeout(()=>this.beep(f,0.3,'sawtooth',0.4),i*240));}
  win(){[392,494,523,659,784].forEach((f,i)=>setTimeout(()=>this.beep(f,0.18,'square',0.5),i*180));}
  startSong(){if(this._songTimer)return;const p=[{n:[392,523,659,523],t:120},{n:[392,523,659,784],t:120},{n:[392,523,659,523],t:120},{n:[349,466,587,698],t:120},];let s=0;const play=()=>{const c=p[s%p.length];c.n.forEach((f,i)=>setTimeout(()=>this.beep(f,0.09,'square',0.35),i*(60000/(c.t*8))));s++;this._songTimer=setTimeout(play,60000/c.t)};play()}
  stopSong(){clearTimeout(this._songTimer);this._songTimer=null;}
  victoryTheme(){
    this.stopSong();
    const fanfare = [659, 784, 988, 1047];
    fanfare.forEach((f,i)=>setTimeout(()=>this.beep(f,0.18,'square',0.55), i*180));
    setTimeout(()=>this._victoryLoop(), fanfare.length*180 + 220);
  }
  _victoryLoop(){
    if (this._songTimer) clearTimeout(this._songTimer);
    const pattern = [
      { n:[659,523,659,784], t:132 },
      { n:[659,523,587,988], t:132 }
    ];
    let s = 0;
    const play = () => {
      const c = pattern[s % pattern.length];
      c.n.forEach((f,i)=>setTimeout(()=>this.beep(f,0.09,'square',0.38), i*(60000/(c.t*8))));
      s++;
      this._songTimer = setTimeout(play, 60000 / pattern[0].t);
    };
    play();
  }
  defeatTheme(){
    this.stopSong();
    const seq = [392, 349, 330, 294, 262];
    seq.forEach((f,i)=>setTimeout(()=>this.beep(f,0.35,'triangle',0.35), i*320));
  }
  encounter(){
    [880, 740, 620, 520, 440].forEach((f,i)=>
      setTimeout(()=>this.beep(f,0.07,'sawtooth',0.45), i*40)
    );
  }
  coin(){
    const seq = [988,1319,1760,2349];
    seq.forEach((f,i)=>setTimeout(()=>this.beep(f,0.07,'square',0.55), i*70));
  }
}

const resultOverlay=document.getElementById('resultOverlay');
const resultTitle=document.getElementById('resultTitle');
const resultMsg=document.getElementById('resultMsg');
const resultYes=document.getElementById('resultYes');
let resultYesHandler=null;
const gameScreen = document.getElementById('game');

function applyScreenFX(mode){
  gameScreen.classList.remove('fx-crt', 'fx-gb', 'fx-pop');
  if(mode === 'crt'){
    gameScreen.classList.add('fx-crt', 'fx-pop');
  }else if(mode === 'gb'){
    gameScreen.classList.add('fx-gb');
  }
}
const sfx=new Chiptune();
window.addEventListener('pointerdown', () => {
  if (sfx.ctx.state === 'suspended') sfx.ctx.resume();
}, { once:true });

/*********** STATE ***********/
const state={
  player:{name:'Apachichu',hp:120,hpMax:120,mp:40,mpMax:40,items:{apple:4,juice:1}},
  enemy:{name:'Roxy',hp:80,hpMax:80},   // easier than Narles
  turn:'player', lock:true, phase:'intro', dialogueIndex:0
};
const dialogue=[
  'Roxy: "Hey, sugar—try not to fall in love while you lose."',
  'Apachichu: "Charm won’t save you once the hooves start flying."',
  'Roxy: "We’ll see. I always get what I wink at."',
  'A battle starts!'
];

/*********** REFS ***********/
const textbox=document.getElementById('textbox');
const mainMenu=document.getElementById('mainMenu');
const fightMenu=document.getElementById('fightMenu');
const itemMenu=document.getElementById('itemMenu');
const fightOverlay=document.getElementById('fightOverlay');
const bagOverlay=document.getElementById('bagOverlay');
const cancelFight=document.getElementById('cancelFight');
const closeBag=document.getElementById('closeBag');
const pHP=document.getElementById('pHP');
const pMP=document.getElementById('pMP');
const eHP=document.getElementById('eHP');
const pHPtxt=document.getElementById('pHPtxt');
const pMPtxt=document.getElementById('pMPtxt');
const eHPtxt=document.getElementById('eHPtxt');
const playerSprite=document.getElementById('playerSprite');
const enemySprite=document.getElementById('enemySprite');
const moveTitle=document.getElementById('moveTitle');
const moveDesc=document.getElementById('moveDesc');
const moveMeta=document.getElementById('moveMeta');

/*********** MOVES (player unchanged) ***********/
const moves=[
  {key:'STOMP',label:'STOMP',mp:4,dmg:[10,18],anim:'step',desc:'Hoof to the face.'},
  {key:'TRANQ',label:'TRANQ',mp:10,dmg:[6,26],anim:'rear',desc:'Sedative spit. Risky.'},
  {key:'NEIGH',label:'NEIGH',mp:8,dmg:[12,22],anim:'rear',desc:'Thunderous battle cry.'},
  {key:'NUG',label:'NUG',mp:6,dmg:[8,20],anim:'step',desc:'Toss a golden nug.'}
];

/* Enemy: Roxy’s charm-forward kit (a little weaker overall) */
const enemyMoves=[
  {key:'PT', label:"Poundtown",     dmg:[6,12],   sprite:'roxy3.png', anim:'step'},
  {key:'TD', label:"Til' Death",    dmg:[10,16],  sprite:'roxy3.png', anim:'flex'},
  {key:'SN', label:"Seductive Neigh", dmg:[6,10], sprite:'roxy2.png', anim:'rear', hearts:true},
  {key:'OG', label:"The Ooshy Gooshy", dmg:[8,14], sprite:'roxy3.png', anim:'flex'}
];

/*********** HELPERS ***********/
const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));
const rnd=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
function updateBars(){
  pHP.style.width=(100*state.player.hp/state.player.hpMax)+'%';
  pMP.style.width=(100*state.player.mp/state.player.mpMax)+'%';
  eHP.style.width=(100*state.enemy.hp/state.enemy.hpMax)+'%';
  pHPtxt.textContent=`HP ${state.player.hp}/${state.player.hpMax}`;
  pMPtxt.textContent=`MP ${state.player.mp}/${state.player.mpMax}`;
  eHPtxt.textContent=`HP ${state.enemy.hp}/${state.enemy.hpMax}`;
}
function setTextbox(t){ textbox.textContent=t; }
function setSelected(c,idx){ const btn=[...c.querySelectorAll('button')]; btn.forEach((b,i)=>b.classList.toggle('sel',i===idx)); c.dataset.sel=idx; }
function currentIndex(c){ return parseInt(c.dataset.sel||'0',10); }

/* Encounter overlay (unchanged) */
const encounterEl = document.getElementById('encounter');
function buildEncounterBars() {
  encounterEl.innerHTML = '';
  for (let i = 0; i < 12; i++) {
    const bar = document.createElement('div');
    bar.className = 'bar' + (i % 2 ? ' r' : '');
    bar.style.setProperty('--from', i % 2 ? '-100%' : '100%');
    bar.style.setProperty('--to',   i % 2 ? '100%'  : '-100%');
    bar.style.animationDelay = `${i * 18}ms, ${240 + i * 18}ms`;
    encounterEl.appendChild(bar);
  }
}
function playEncounterTransition(onDone){
  buildEncounterBars();
  encounterEl.style.opacity = '1';
  encounterEl.classList.add('show');
  encounterEl.setAttribute('aria-hidden','false');
  sfx.encounter();
  const staggerLast = 11 * 18;
  const inDur = 220, outDelay = 240, outDur = 260;
  const total = staggerLast + outDelay + inDur + outDur;
  const displaceStart = total - 360;
  setTimeout(() => { gameScreen.classList.add('displace'); }, displaceStart);
  const fadeStart = total - 140;
  setTimeout(() => { encounterEl.style.opacity = '0'; }, fadeStart);
  setTimeout(() => {
    gameScreen.classList.remove('displace');
    encounterEl.classList.remove('show');
    encounterEl.setAttribute('aria-hidden','true');
    encounterEl.innerHTML = '';
    encounterEl.style.opacity = '1';
    if (onDone) onDone();
  }, total + 80);
}

/* Hearts emitter used by Seductive Neigh */
function emitHearts(fromEl, count=8){
  const r = fromEl.getBoundingClientRect();
  for(let i=0;i<count;i++){
    const h=document.createElement('div'); h.className='heart';
    const x = r.left + r.width*0.55 + (Math.random()*20-10);
    const y = r.top + r.height*0.25 + (Math.random()*12-6);
    h.style.left = `${x}px`; h.style.top = `${y}px`;
    h.style.animationDelay = `${i*40}ms`;
    document.body.appendChild(h);
    setTimeout(()=>h.remove(), 1100);
  }
}

function showResult(title, msg, options={}){
  resultTitle.textContent = title;
  resultMsg.textContent = msg;
  resultOverlay.classList.add('show');
  resultOverlay.setAttribute('aria-hidden','false');
  resultYes.focus();
  resultYesHandler = typeof options.onYes === 'function' ? options.onYes : null;
}
function restartGame(){ location.reload(); }
resultYes.addEventListener('click', ()=>{
  if (resultYesHandler) { const handler = resultYesHandler; resultYesHandler = null; handler(); }
  else { restartGame(); }
});

/*********** MENUS ***********/
function buildMenus(){
  // Fight
  fightMenu.innerHTML='';
  moves.forEach((m,i)=>{
    const b=document.createElement('button');
    b.textContent=`${m.label}  (MP ${m.mp})`;
    b.addEventListener('mouseenter',()=>showMoveInfo(i));
    b.addEventListener('focus',()=>showMoveInfo(i));
    b.addEventListener('click',()=>chooseMove(i));
    fightMenu.appendChild(b);
  });
  setSelected(fightMenu,0); showMoveInfo(0);

  // Items
  itemMenu.innerHTML='';
  const a=document.createElement('button'); a.id='appleBtn'; a.textContent=`Apple Drank x${state.player.items.apple}  (+12 MP)`; a.onclick=()=>useItem('apple');
  const j=document.createElement('button'); j.id='juiceBtn'; j.textContent=`Restor'O'Juice x${state.player.items.juice}  (+40 HP)`; j.onclick=()=>useItem('juice');
  itemMenu.append(a,j);
  setSelected(itemMenu,0);
}
function refreshItemCounts(){
  document.getElementById('appleBtn').textContent=`Apple Drank x${state.player.items.apple}  (+12 MP)`;
  document.getElementById('juiceBtn').textContent=`Restor'O'Juice x${state.player.items.juice}  (+40 HP)`;
}
function showMoveInfo(i){ const m=moves[i]; moveTitle.textContent=m.label; moveDesc.textContent=m.desc; moveMeta.textContent=`MP ${m.mp} | Damage ${m.dmg[0]}–${m.dmg[1]}`; }

function buildMainMenu(){
  mainMenu.innerHTML = '';
  const actions = [
    {label:'FIGHT', action:'FIGHT'},
    {label:'BAG',   action:'ITEMS'},
    {label:'INFO',  action:'INFO'},
    {label:'RUN',   action:'RUN'}
  ];
  actions.forEach((a,i)=>{
    const b = document.createElement('button');
    b.textContent = a.label;
    b.dataset.action = a.action;
    if(i===0) b.classList.add('sel');
    mainMenu.appendChild(b);
  });
  setSelected(mainMenu,0);
}

/*********** INTRO ***********/
function advanceDialogue(){
  if(state.phase!=='intro')return;
  sfx.blip();
  if(state.dialogueIndex<dialogue.length){
    setTextbox(dialogue[state.dialogueIndex++]);
  } else {
    state.phase='battle'; state.lock=false;
    textbox.classList.remove('attn');
    setTextbox('What will Apachichu do?');
    buildMainMenu();
    sfx.startSong();
  }
}
textbox.addEventListener('click',advanceDialogue);

/*********** INPUT ***********/
mainMenu.addEventListener('click',e=>{
  const act=e.target.dataset.action; if(!act||state.lock||state.phase!=='battle')return; sfx.blip();
  if(act==='FIGHT') openFight();
  else if(act==='ITEMS') openBag();
  else if(act==='INFO') setTextbox('Use MP wisely. Press FIGHT to choose a move.');
  else if(act==='RUN'){ setTextbox('You cannot run from Roxy. She winks confidently.'); sfx.miss(); }
});
window.addEventListener('keydown',e=>{
  if(state.phase==='intro'&&(e.key==='Enter'||e.key===' ')){advanceDialogue();return;}
  if(state.phase!=='battle')return;
  const grid = fightOverlay.classList.contains('show') ? fightMenu :
               bagOverlay.classList.contains('show')   ? itemMenu  : mainMenu;
  let idx=currentIndex(grid);
  if(['ArrowDown','s','S'].includes(e.key)) idx=Math.min(idx+1,grid.querySelectorAll('button').length-1);
  if(['ArrowUp','w','W'].includes(e.key)) idx=Math.max(idx-1,0);
  if(['ArrowRight','d','D'].includes(e.key)) idx=Math.min(idx+1,grid.querySelectorAll('button').length-1);
  if(['ArrowLeft','a','A'].includes(e.key)) idx=Math.max(idx-1,0);
  setSelected(grid,idx);
  if(e.key==='Enter'||e.key===' ') grid.querySelectorAll('button')[idx].click();
  if(e.key==='Escape'||e.key==='Backspace'){
    if(fightOverlay.classList.contains('show')) closeFight();
    else if(bagOverlay.classList.contains('show')) closeBagOverlay();
  }
});
function openFight(){ fightOverlay.classList.add('show'); fightOverlay.setAttribute('aria-hidden','false'); setSelected(fightMenu,0); showMoveInfo(0); }
function closeFight(){ fightOverlay.classList.remove('show'); fightOverlay.setAttribute('aria-hidden','true'); }
cancelFight.addEventListener('click',closeFight);
function openBag(){ bagOverlay.classList.add('show'); bagOverlay.setAttribute('aria-hidden','false'); setSelected(itemMenu,0); }
function closeBagOverlay(){ bagOverlay.classList.remove('show'); bagOverlay.setAttribute('aria-hidden','true'); }
closeBag.addEventListener('click',closeBagOverlay);

/*********** COMBAT ***********/
function projectile(fromEl,toEl,img){
  const r1=fromEl.getBoundingClientRect(), r2=toEl.getBoundingClientRect();
  const p=document.createElement('img'); p.src=img; Object.assign(p.style,{position:'fixed',left:(r1.left+r1.width*0.6)+'px',top:(r1.top+r1.height*0.3)+'px',width:'40px',height:'40px',imageRendering:'pixelated',zIndex:9999});
  document.body.appendChild(p);
  const dx=r2.left+r2.width*0.4-(r1.left+r1.width*0.6), dy=r2.top+r2.height*0.5-(r1.top+r1.height*0.3);
  p.animate([{transform:'translate(0,0)'},{transform:`translate(${dx}px,${dy}px)`}],{duration:350,easing:'linear'}).finished.then(()=>{p.remove(); enemySprite.classList.add('hit'); setTimeout(()=>enemySprite.classList.remove('hit'),220)});
}
function chooseMove(i){ if(state.lock||state.phase!=='battle')return; const m=moves[i]; if((state.player.mp??0)<m.mp){ setTextbox('Not enough MP!'); sfx.miss(); return;} closeFight(); actPlayerMove(m); }
function actPlayerMove(m){
  state.lock=true; state.player.mp=(state.player.mp??0)-m.mp; updateBars();
  setTextbox(`${state.player.name} used ${m.label}!`); sfx.blip();
  playerSprite.classList.add(m.anim); setTimeout(()=>playerSprite.classList.remove(m.anim),340);
  if(m.key==='NUG') projectile(playerSprite,enemySprite,'nug.png');
  setTimeout(()=>{
    const miss=0.12, crit=0.16;
    if(Math.random()<miss){ setTextbox('…but it missed!'); sfx.miss(); return setTimeout(enemyTurn,600); }
    let dmg=rnd(m.dmg[0],m.dmg[1]);
    if(Math.random()<crit){ dmg=Math.floor(dmg*1.5); setTextbox('A critical hit!'); }
    state.enemy.hp=clamp(state.enemy.hp-dmg,0,state.enemy.hpMax); updateBars();
    enemySprite.classList.add('hit'); sfx.hit(); setTimeout(()=>enemySprite.classList.remove('hit'),260);
    if(state.enemy.hp<=0) return win();
    setTimeout(enemyTurn,700);
  },380);
}
function useItem(which){
  if(state.lock||state.phase!=='battle')return;
  if(which==='apple'){
    if(state.player.items.apple<=0){ setTextbox('No Apple Drank left!'); sfx.miss(); return;}
    state.player.items.apple--; state.player.mp=clamp((state.player.mp??0)+12,0,state.player.mpMax);
    refreshItemCounts(); updateBars(); setTextbox('Apachichu sips Apple Drank! MP +12'); sfx.heal();
  } else {
    if(state.player.items.juice<=0){ setTextbox("No Restor'O'Juice left!"); sfx.miss(); return;}
    state.player.items.juice--; state.player.hp=clamp(state.player.hp+40,0,state.player.hpMax);
    refreshItemCounts(); updateBars(); setTextbox("Apachichu guzzles Restor'O'Juice! HP +40"); sfx.heal();
  }
  state.lock=true; setTimeout(()=>{closeBagOverlay(); enemyTurn();},650);
}

/* Enemy AI */
function enemyTurn(){
  if(state.phase!=='battle') return;

  const m = enemyMoves[rnd(0, enemyMoves.length-1)];
  state.lock = true;

  setTextbox(`Roxy used ${m.label}!`);

  setTimeout(() => {
    const old = enemySprite.src;
    enemySprite.src = m.sprite;
    enemySprite.classList.add(m.anim);
    sfx.blip?.();

    setTimeout(() => {
      enemySprite.classList.remove(m.anim);

      // charm has a slightly higher "miss" chance—Roxy dazzles more than damages
      const dodge = 0.14; // easier fight than Narles
      if (Math.random() < dodge) {
        setTextbox('Apachichu dodged it!');
        sfx.miss();
        enemySprite.src = 'roxy.png';
        return setTimeout(endEnemy, SPEED.postHit);
      }

      // Hearts for Seductive Neigh
      if (m.hearts) emitHearts(enemySprite, 10);

      const dmg = rnd(m.dmg[0], m.dmg[1]);
      state.player.hp = clamp(state.player.hp - dmg, 0, state.player.hpMax);
      updateBars();

      playerSprite.classList.add('hit');
      sfx.hit();
      setTimeout(()=>playerSprite.classList.remove('hit'), 260);

      enemySprite.src = 'roxy.png';

      if (state.player.hp <= 0) return lose();

      setTextbox(`It dealt ${dmg} damage!`);
      setTimeout(endEnemy, SPEED.postHit);

    }, SPEED.windup);
  }, SPEED.enemyRead);
}
const endEnemy = () => { state.lock = false; setTextbox('What will Apachichu do?'); };

function win(){
  state.phase='end';
  state.lock=true;
  setTextbox('Roxy fainted! You win.');

  enemySprite.src='roxy4.png';
  enemySprite.classList.add('flex');
  setTimeout(()=>enemySprite.classList.remove('flex'), 360);

  sfx.stopSong();
  sfx.victoryTheme();
  setTimeout(()=>sfx.coin(), 600);

  showResult(
    'GAME LORDS',
    "Good job, dude.... I was almost impressed. Next time try to do it faster. Here's 500 points.",
    {
      onYes: () => {
        try { window.parent.postMessage({ type: 'apachemonResult', outcome: 'victory' }, '*'); }
        catch (err) { console.error('Mini-game postMessage failed', err); }
      }
    }
  );
}
function lose(){
  state.phase='end';
  state.lock=true;
  setTextbox('Apachichu fainted… You blacked out.');
  sfx.stopSong(); sfx.defeatTheme();
  showResult('GAME LORDS','Aww, you sucked. Want to try again lil guy?',{ onYes: restartGame });
}

/*********** INIT ***********/
state.player.mp = 40;
buildMenus();
updateBars();
mainMenu.innerHTML = '';        // hide menu during intro
textbox.classList.add('attn');  // draw attention to dialogue
applyScreenFX('gb');            // keep GB overlay

playEncounterTransition(()=>{
  state.phase = 'intro';
  state.dialogueIndex = 0;
  setTextbox('Apachichu entered the arena. Roxy flicked her mane and blew a kiss. Tap/click to continue…');
});
</script>
</body>
</html>
