var gdjs;(function(h){const d=new h.Logger("Audio manager"),f=["audio"],_={preload:!0,onplayerror:(a,e)=>d.error("Can't play an audio file: "+e),onloaderror:(a,e)=>d.error("Error while loading an audio file: "+e)},c=a=>a>1?1:a<0?0:a,u=(a,e)=>{if(a instanceof Error&&a.message&&typeof a.message=="string"&&a.message.startsWith("Maximum call stack size exceeded"))console.warn(`An error occurred when call method "${e}":`,a);else throw a};class w{constructor(e,s,t,i){this._id=null;this._oncePlay=[];this._onPlay=[];this._howl=e,this._initialVolume=c(s),this._loop=t,this._rate=i}isLoaded(){return this._howl.state()==="loaded"}play(){try{if(this.isLoaded()){const e=this._howl.play(this._id===null?"__default":this._id);this._id=e,this._howl.volume(this._initialVolume,e),this._howl.loop(this._loop,e),this._howl.rate(h.HowlerSoundManager.clampRate(this._rate),e),this._onPlay.forEach(s=>{this.on("play",s),s(e)}),this._oncePlay.forEach(s=>s(e)),this._onPlay=[],this._oncePlay=[]}else this._howl.once("load",()=>this.play())}catch(e){u(e,"play")}return this}pause(){try{this._id!==null&&this._howl.pause(this._id)}catch(e){u(e,"pause")}return this}stop(){try{this._id!==null&&this._howl.stop(this._id)}catch(e){u(e,"stop")}return this}playing(){return(this._id!==null?this._howl.playing(this._id):!0)||!this.isLoaded()}paused(){return!this.playing()}stopped(){return this.paused()&&this.getSeek()===0}getRate(){return this._rate}setRate(e){try{this._rate=e,this._id!==null&&(e=h.HowlerSoundManager.clampRate(e),this._howl.rate(e,this._id))}catch(s){u(s,"rate")}return this}getLoop(){return this._loop}setLoop(e){try{this._loop=e,this._id!==null&&this._howl.loop(e,this._id)}catch(s){u(s,"loop")}return this}getVolume(){return this._id===null?this._initialVolume:this._howl.volume(this._id)}setVolume(e){try{this._initialVolume=c(e),this._id!==null&&this._howl.volume(this._initialVolume,this._id)}catch(s){u(s,"volume")}return this}getMute(){return this._id===null?!1:this._howl.mute(this._id)}setMute(e){try{this._id!==null&&this._howl.mute(e,this._id)}catch(s){u(s,"mute")}return this}getSeek(){return this._id===null?0:this._howl.seek(this._id)}setSeek(e){try{this._id!==null&&this._howl.seek(e,this._id)}catch(s){u(s,"seek")}return this}getSpatialPosition(e){return this._id===null?0:this._howl.pos(this._id)[e==="x"?0:e==="y"?1:2]}setSpatialPosition(e,s,t){return this._id!==null&&this._howl.pos(e,s,t,this._id),this}fade(e,s,t){try{this._id!==null&&this._howl.fade(c(e),c(s),t,this._id)}catch(i){u(i,"fade")}return this}on(e,s){return e==="play"?this._id===null?this._onPlay.push(s):this._howl.on(e,s,this._id):this._id===null?this.once("play",()=>this.on(e,s)):this._howl.on(e,s,this._id),this}once(e,s){return e==="play"?this._id===null?this._oncePlay.push(s):this.playing()?s(this._id):this._howl.once(e,s,this._id):this._id===null?this.once("play",()=>this.once(e,s)):this._howl.once(e,s,this._id),this}off(e,s){return this._id!==null&&this._howl.off(e,s,this._id),this}}h.HowlerSound=w;class p{constructor(e){this._loadedMusics=new h.ResourceCache;this._loadedSounds=new h.ResourceCache;this._availableResources={};this._globalVolume=100;this._sounds={};this._cachedSpatialPosition={};this._musics={};this._freeSounds=[];this._freeMusics=[];this._pausedSounds=[];this._paused=!1;this._getAudioResource=e=>{const s=this._resourceLoader.getResource(e);return s&&this.getResourceKinds().includes(s.kind)?s:{file:e,kind:"audio",metadata:"",name:e}};this._resourceLoader=e,h.registerRuntimeScenePostEventsCallback(this._clearCachedSpatialPosition.bind(this));const s=this;document.addEventListener("deviceready",function(){document.addEventListener("pause",function(){s.pauseAllActiveSounds()},!1),document.addEventListener("resume",function(){s.resumeAllActiveSounds()},!1)})}pauseAllActiveSounds(){const e=this._freeSounds.concat(this._freeMusics);for(let s in this._sounds)this._sounds.hasOwnProperty(s)&&e.push(this._sounds[s]);for(let s in this._musics)this._musics.hasOwnProperty(s)&&e.push(this._musics[s]);for(let s=0;s<e.length;s++){const t=e[s];!t.paused()&&!t.stopped()&&(t.pause(),this._pausedSounds.push(t))}this._paused=!0}resumeAllActiveSounds(){try{for(let e=0;e<this._pausedSounds.length;e++){const s=this._pausedSounds[e];s.stopped()||s.play()}}catch(e){if(e.message&&typeof e.message=="string"&&e.message.startsWith("Maximum call stack size exceeded"))console.warn("An error occurred when resuming paused sounds while the game was in background:",e);else throw e}this._pausedSounds.length=0,this._paused=!1}getResourceKinds(){return f}static clampRate(e){return e>4?4:e<.5?.5:e}_getSoundUrlsFromResource(e){return[this._resourceLoader.getFullUrl(e.file)]}_getDefaultSoundUrl(e){return this._resourceLoader.getFullUrl(e.file)}_preloadAudioFile(e,s){const t=e.file;return new Promise((i,l)=>{const o=s?this._loadedMusics:this._loadedSounds;o[t]=new Howl(Object.assign({},_,{src:this._getSoundUrlsFromResource(e),onload:i,onloaderror:(r,n)=>l(n),html5:s,xhr:{withCredentials:this._resourceLoader.checkIfCredentialsRequired(t)},volume:0}))})}_storeSoundInArray(e,s){for(let t=0,i=e.length;t<i;++t)if(!e[t]||e[t].stopped())return e[t]=s,s;return e.push(s),s}createHowlerSound(e,s,t,i,l){const o=s?this._loadedMusics:this._loadedSounds,r=this._getAudioResource(e);let n=o.get(r);return n||(n=new Howl(Object.assign({src:this._getSoundUrlsFromResource(r),html5:s,xhr:{withCredentials:this._resourceLoader.checkIfCredentialsRequired(r.file)},volume:0},_)),o.set(r,n)),new h.HowlerSound(n,t,i,l)}loadAudio(e,s){const t=s?this._loadedMusics:this._loadedSounds,i=this._getAudioResource(e);t.get(i)||t.set(i,new Howl(Object.assign({src:this._getSoundUrlsFromResource(i),html5:s,xhr:{withCredentials:this._resourceLoader.checkIfCredentialsRequired(i.file)},volume:0},_)))}unloadAudio(e,s){const t=s?this._loadedMusics:this._loadedSounds,i=this._getAudioResource(e),l=t.get(i);if(!l)return;function o(r){for(let n in r)r[n]&&r[n]._howl===l&&(r[n].stop(),delete r[n])}o(this._freeMusics),o(this._freeSounds),o(Object.values(this._musics)),o(Object.values(this._sounds)),o(this._pausedSounds),l.unload(),t.delete(i)}unloadAll(){Howler.unload(),this._freeSounds.length=0,this._freeMusics.length=0,this._sounds={},this._musics={},this._pausedSounds.length=0,this._loadedMusics.clear(),this._loadedSounds.clear()}playSound(e,s,t,i){const l=this.createHowlerSound(e,!1,t/100,s,i);this._storeSoundInArray(this._freeSounds,l),l.once("play",()=>{this._paused&&(l.pause(),this._pausedSounds.push(l))}),l.play()}playSoundOnChannel(e,s,t,i,l){this._sounds[s]&&this._sounds[s].stop();const o=this.createHowlerSound(e,!1,i/100,t,l),r=this._cachedSpatialPosition[s];r&&o.once("play",()=>{o.setSpatialPosition(...r)}),this._sounds[s]=o,o.once("play",()=>{this._paused&&(o.pause(),this._pausedSounds.push(o))}),o.play()}getSoundOnChannel(e){return this._sounds[e]||null}playMusic(e,s,t,i){const l=this.createHowlerSound(e,!0,t/100,s,i);this._storeSoundInArray(this._freeMusics,l),l.once("play",()=>{this._paused&&(l.pause(),this._pausedSounds.push(l))}),l.play()}playMusicOnChannel(e,s,t,i,l){this._musics[s]&&this._musics[s].stop();const o=this.createHowlerSound(e,!0,i/100,t,l);this._musics[s]=o,o.once("play",()=>{this._paused&&(o.pause(),this._pausedSounds.push(o))}),o.play()}getMusicOnChannel(e){return this._musics[e]||null}setSoundSpatialPositionOnChannel(e,s,t,i){const l=this.getSoundOnChannel(e);l&&!l.paused()?l.setSpatialPosition(s,t,i):this._cachedSpatialPosition[e]=[s,t,i]}_clearCachedSpatialPosition(){this._cachedSpatialPosition={}}setGlobalVolume(e){this._globalVolume=e,this._globalVolume>100&&(this._globalVolume=100),this._globalVolume<0&&(this._globalVolume=0),Howler.volume(this._globalVolume/100)}getGlobalVolume(){return this._globalVolume}clearAll(){Howler.stop(),this._freeSounds.length=0,this._freeMusics.length=0,this._sounds={},this._musics={},this._pausedSounds.length=0}async processResource(e){}async loadResource(e){const s=this._resourceLoader.getResource(e);if(!s){d.warn('Unable to find audio for resource "'+e+'".');return}if(s.file){if(this._availableResources[s.name])return;this._availableResources[s.name]=s}if(s.preloadAsMusic)try{await this._preloadAudioFile(s,!0)}catch(t){d.warn("There was an error while preloading an audio file: "+t)}if(s.preloadAsSound)try{await this._preloadAudioFile(s,!1)}catch(t){d.warn("There was an error while preloading an audio file: "+t)}else if(s.preloadInCache||!s.preloadAsMusic)try{const t=s.file;await new Promise((i,l)=>{const o=new XMLHttpRequest;o.withCredentials=this._resourceLoader.checkIfCredentialsRequired(t),o.addEventListener("load",i),o.addEventListener("error",r=>l("XHR error: "+t)),o.addEventListener("abort",r=>l("XHR abort: "+t)),o.open("GET",this._getDefaultSoundUrl(s)),o.send()})}catch(t){d.warn("There was an error while preloading an audio file: "+t)}}dispose(){this.unloadAll()}unloadResource(e){this._loadedMusics.get(e)&&this.unloadAudio(e.name,!0),this._loadedSounds.get(e)&&this.unloadAudio(e.name,!1)}}h.HowlerSoundManager=p,h.SoundManager=p})(gdjs||(gdjs={}));
//# sourceMappingURL=howler-sound-manager.js.map
